<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Hydra Viewer</title>
	<link rel="icon" type="image/x-icon" href="./lib/favicon.ico">
	<link rel="stylesheet" type="text/css" href="./lib/style.css">
    <script src="./lib/d3.min.js"></script>
	<script src="./lib/highlight.min.js"></script>
	<script src="./lib/jquery-1.11.3.min.js"></script>
	<!-- libraries for share this -->
	<script type="text/javascript">var switchTo5x=true;</script>
	<script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
	<script type="text/javascript" src="https://w.sharethis.com/button/buttons.js"></script>
	<script type="text/javascript">stLight.options({publisher: "8146e8ed-b6ac-46c1-a80d-3d5c4ba828e3", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>
</head>

<body>
<div class="header"></div>
<div>
	<h1 class="example-description"></h1>
	<span class='st_sharethis_hcount' displayText='ShareThis'></span>
	<span class='st_email_hcount' displayText='Email'></span>
	<span class='st_facebook_hcount' displayText='Facebook'></span>
	<span class='st_twitter_hcount' displayText='Tweet'></span>
	<span class='st_linkedin_hcount' displayText='LinkedIn'></span>
	<span class='st_googleplus_hcount' displayText='Google +'></span>
</div>
<br></br>
<div id="imageContainer"></div>
<br></br>
<form id="example-download">
	<button type="submit">Download</button>
</form>
<div class="example-tags"></div>
<div class="example-readme"></div>

<script data-cfasync="false" type="text/javascript">
var example;

function parseUri(){
	
	var inputParameters = {
		owner : "",
		description : ""
	}
	
	// parse Uri
	var pars = window.location.search.replace("?","").split("&")
	
	if (pars[0]=="") {
		alert("wrong address!");
		return;
	}

	pars.forEach(function(d){
		keyValue = d.split("=");
		inputParameters[keyValue[0].toLowerCase()] = keyValue[1];
	})

	var owner = inputParameters.owner,
		description = inputParameters.description;

	// read the json file
	var githubBase = "https://raw.githubusercontent.com/" + owner + "/hydra/master/" + description;
	var jsonFile = githubBase + "/input.json";
                    
    d3.json(jsonFile, function(error, data){
    	// use the id to get the following github information
		example = {
			"owner": owner,
			"description": description,
			"fork_path": "http://www.github.com/" + owner + "/hydra/tree/master/" + description,
			"image_path": githubBase + "/" + data.ghimg,
			"download_path": githubBase + "/" + data.file,
			"readme_path": githubBase + "/README.md",
			"components": data.components,
			"tags": data.tags,
			"versions": data.versions,
			"created_at":data.date
		};
		generateContent(example);
    });
};
parseUri();

function generateContent(){

	// script for title
	d3.select("title").text(example.description);
	
	// script for header
	var header = d3.select(".header").append("span")
	  .text(example.owner +"'s example ");
	header.append("a")
	  .attr("class","example")
	  .attr("title","View example on Github")
	  .attr("href", example.fork_path)
	  .text(example.description + " ");
	header.append("span")
	  .attr("class","date")
	  .text("created: " + example.created_at);
	header.append("a")
	  .attr("href","https://hydrashare.github.io/hydra/index.html")
	  .style("float","right")
	  .text("Return to Hydra Main Page")

	// script for description
	d3.select(".example-description").text(example.description);

	// script for tracking downloads
	jQuery(document).ready(function( $ ) {
		var request;
		// bind the download submit event to the form
		$("#example-download").submit(function(event){
			//download the zip file from github
			window.location = example.download_path;
			
			// abort any pending request
			if (request) {  
				request.abort();
			}
			
			// setup some local variables
			var $form = $(this);  		
			var $inputs = $form.find("button");
			$inputs.prop("disabled", true);
			$('#downloadCount').text('#');		
			data={"owner":example.owner,"description":example.description,"request_type":"increment"};
			
			// fire off the request to /form.php
			request = $.ajax({
				url: "https://script.google.com/macros/s/AKfycbxiRnl-119Qy-Ygchrjp5OiMelYUJCZ-ZHjpwKTm6dtaYCOZ9IZ/exec",
				type: "post",
				data: data
			});
			
			// callback handler that will be called on success
			request.done(function (response, textStatus, jqXHR){
				// log a message to the console
				$('#downloadCount').text(response.downloads);
				console.log(response);
			});
			// callback handler that will be called on failure
			request.fail(function (jqXHR, textStatus, errorThrown){
				// log the error to the console
				console.error("The following error occured: " + textStatus, errorThrown);
			});
			// callback handler that will be called regardless if the request failed or succeeded
			request.always(function () {
				// reenable the inputs
				$inputs.prop("disabled", false);
			});
			
			// prevent default posting of form
			event.preventDefault();
		});
	});

	// script for zooming and panning .png images
	var imgWidth = 960,imgHeight = 480,		// Image dimensions (don't change these)
	    width =  960, height = 480,         // Dimensions of cropped region
	    translate0 = [0, 0], scale0 = 1;    // Initial offset & scale

	svg = d3.select("#imageContainer").append("svg")
	    .attr("width",  width + "px")
	    .attr("height", height + "px");

	svg.append("rect")
	    .attr("class", "overlay")
	    .attr("width", width + "px")
	    .attr("height", height + "px");

	svg = svg.append("g")
	    .attr("transform", "translate(" + translate0 + ")scale(" + scale0 + ")")
	    .call(d3.behavior.zoom().scaleExtent([1, 8]).on("zoom", zoom))
	  .append("g");

	svg.append("image")
	    .attr("width",  imgWidth + "px")
	    .attr("height", imgHeight + "px")
	    .attr("xlink:href", example.image_path);

	function zoom() {
	  svg.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
	};
	
	// script for tags
	

	// script for readme
	var readme = d3.selectAll(".example-readme")
	    d3.text(example.readme_path, function(error, content) {
	        readme.html(new Showdown.converter().makeHtml(content));
	        readme.selectAll("code").each(function() { hljs.highlightBlock(this); });
	    });
}
</script>

</html>